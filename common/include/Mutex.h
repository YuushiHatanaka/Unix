//==============================================================================
// Mutexクラスヘッダ
//==============================================================================
#ifndef _MUTEX_H_                           // 二重インクルード防止
#define _MUTEX_H_                           // 二重インクルード防止

//==============================================================================
// インクルードファイル
//==============================================================================
#include "Object.h"
#include "Exception.h"
#include <pthread.h>

//==============================================================================
// クラス定義
//==============================================================================
//------------------------------------------------------------------------------
// Mutex例外クラス
//------------------------------------------------------------------------------
class MutexException : public Exception
{
public:
    //--------------------------------------------------------------------------
    // コンストラクタ
    //--------------------------------------------------------------------------
    MutexException(std::string format, ...)
        : Exception()
    {
        // メッセージ生成
        va_list ap;
        va_start(ap, format);
        this->SetMessage(format, ap);
        va_end(ap);
    };
};

//------------------------------------------------------------------------------
// Mutexクラス
//------------------------------------------------------------------------------
class Mutex : public Object
{
protected:
    pthread_mutex_t m_mutex;                // mutexオブジェクト

public:
    //--------------------------------------------------------------------------
    // コンストラクタ
    //--------------------------------------------------------------------------
    Mutex() : Object()
    {
        // 初期化
        pthread_mutex_init(&(this->m_mutex), NULL);
    }

    //--------------------------------------------------------------------------
    // コピーコンストラクタ
    //--------------------------------------------------------------------------
    Mutex(const Mutex& mutex) : Object()
    {
        // コピー
        this->m_mutex = mutex.m_mutex;
        this->m_errno = mutex.m_errno;
    }

    //--------------------------------------------------------------------------
    // デストラクタ
    //--------------------------------------------------------------------------
    virtual ~Mutex()
    {
        // 破棄
        pthread_mutex_destroy(&(this->m_mutex));
    }

    //--------------------------------------------------------------------------
    // 排他設定
    //--------------------------------------------------------------------------
    bool Lock()
    {
        // mutex設定
        if(pthread_mutex_lock(&(this->m_mutex)) != 0)
        {
            // エラー番号設定
            this->SetErrno();

            // 異常終了
            return false;
        }

        // 正常終了
        return true;
    }

    //--------------------------------------------------------------------------
    // 排他設定
    //--------------------------------------------------------------------------
    bool Trylock()
    {
        // mutex設定
        if(pthread_mutex_trylock(&(this->m_mutex)) != 0)
        {
            // エラー番号設定
            this->SetErrno();

            // ロック中
            return false;
        }

        // 正常終了
        return true;
    }

    //--------------------------------------------------------------------------
    // 排他解除
    //--------------------------------------------------------------------------
    bool Unlock()
    {
        // mutex解除
        if(pthread_mutex_unlock(&(this->m_mutex)) != 0)
        {
            // エラー番号設定
            this->SetErrno();

            // 異常終了
            return false;
        }

        // 正常終了
        return true;
    }
};
#endif                                      // 二重インクルード防止
